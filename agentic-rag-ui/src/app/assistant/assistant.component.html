<!-- ============================================================================ -->
<!-- TEMPLATE - assistant.component.html (VERSION FINALE CORRIGÉE) -->
<!-- ============================================================================ -->
<div class="container-fluid vh-100 p-0">
  <div class="row g-0 h-100">
    
    <!-- ========================================== -->
    <!-- SIDEBAR - Fichiers Uploadés -->
    <!-- ========================================== -->
    <aside class="col-lg-3 col-md-4 col-12 bg-white border-end shadow-sm d-flex flex-column">
      
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
        <h5 class="mb-0 fw-bold">
          <i class="bi bi-folder-fill text-primary me-2"></i>
          Fichiers Uploadés
        </h5>
        <button 
          *ngIf="hasFiles$ | async" 
          class="btn btn-sm btn-outline-danger"
          (click)="clearFiles()"
          title="Supprimer tous les fichiers">
          <i class="bi bi-trash"></i>
        </button>
      </div>
      
      <!-- Liste des fichiers -->
      <div class="flex-grow-1 overflow-auto p-3 custom-scrollbar">
        <div class="list-group list-group-flush">
          <div 
            *ngFor="let file of files$ | async; trackBy: trackByFileId" 
            class="list-group-item border rounded mb-2"
            [ngClass]="{
              'border-success bg-success-subtle': file.status === 'success',
              'border-warning bg-warning-subtle': file.status === 'uploading',
              'border-danger bg-danger-subtle': file.status === 'error'
            }">
            
            <div class="d-flex align-items-start">
              <div class="me-3 fs-3">
                {{ getFileIcon(file.name) }}
              </div>
              
              <div class="flex-grow-1">
                <h6 class="mb-1 text-truncate" [title]="file.name">{{ file.name }}</h6>
                <small class="text-muted">
                  {{ formatFileSize(file.size) }}
                  <span *ngIf="file.status === 'uploading' && file.progress"> 
                    • {{ file.progress }}%
                  </span>
                  <span *ngIf="file.status === 'success'">
                    • {{ formatTime(file.uploadDate) }}
                  </span>
                </small>
                
                <div *ngIf="file.status === 'uploading' && file.progress !== undefined" 
                     class="progress mt-2" 
                     style="height: 4px;">
                  <div 
                    class="progress-bar progress-bar-striped progress-bar-animated bg-warning" 
                    role="progressbar" 
                    [style.width.%]="file.progress"
                    [attr.aria-valuenow]="file.progress"
                    aria-valuemin="0" 
                    aria-valuemax="100">
                  </div>
                </div>
                
                <small *ngIf="file.status === 'error'" class="text-danger d-block mt-1">
                  <i class="bi bi-exclamation-circle"></i> Échec de l'upload
                </small>
              </div>
            </div>
          </div>
          
          <div *ngIf="!(hasFiles$ | async)" class="text-center py-5">
            <i class="bi bi-folder2-open display-1 text-muted opacity-50"></i>
            <p class="text-muted mt-3">Aucun fichier uploadé</p>
          </div>
        </div>
      </div>
      
      <!-- Zone d'upload -->
      <div class="p-3 border-top">
        <div 
          class="upload-zone border border-2 border-dashed rounded-3 p-4 text-center"
          [ngClass]="{
            'border-primary bg-primary-subtle': dragOver,
            'border-secondary': !dragOver,
            'opacity-50': uploading$ | async
          }"
          (click)="triggerFileInput()"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)"
          (drop)="onDrop($event)"
          [style.cursor]="(uploading$ | async) ? 'not-allowed' : 'pointer'">
          
          <input 
            #fileInput
            type="file" 
            hidden 
            (change)="onFileSelected($event)"
            accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.xlsx,.xls"
            [disabled]="uploading$ | async">
          
          <div *ngIf="!(uploading$ | async)">
            <i class="bi bi-cloud-upload display-4 text-primary"></i>
            <p class="mt-3 mb-1">
              <strong class="text-primary">Cliquez</strong> ou glissez un fichier
            </p>
            <small class="text-muted">PDF, DOCX, TXT, Images (max 50MB)</small>
          </div>
          
          <div *ngIf="uploading$ | async">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Chargement...</span>
            </div>
            <p class="mt-3 mb-0 text-muted">Upload en cours...</p>
          </div>
        </div>
      </div>
      
    </aside>
    
    <!-- ========================================== -->
    <!-- MAIN - Zone de Chat -->
    <!-- ========================================== -->
    <main class="col-lg-9 col-md-8 col-12 d-flex flex-column bg-light">
      
      <!-- Header -->
      <header class="bg-gradient p-3 shadow-sm" 
              style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h4 class="mb-1 text-dark fw-bold">
              <i class="bi bi-robot me-2"></i>
              Assistant RAG Multimodal
            </h4>
            <p class="mb-0 small text-dark opacity-75">
              Posez vos questions sur les documents uploadés
            </p>
          </div>
          <div class="d-flex gap-2">
            <button 
              class="btn btn-light btn-sm"
              (click)="exportHistory()"
              title="Exporter l'historique">
              <i class="bi bi-download"></i>
            </button>
            <button 
              *ngIf="hasMessages$ | async"
              class="btn btn-light btn-sm"
              (click)="clearChat()">
              <i class="bi bi-trash me-1"></i>
              Effacer
            </button>
          </div>
        </div>
      </header>
      
      <!-- Messages Container -->
      <div #chatContainer 
           class="flex-grow-1 overflow-auto p-4 custom-scrollbar" 
           style="scroll-behavior: smooth;">
        
        <!-- Messages -->
        <div 
          *ngFor="let msg of messages$ | async; trackBy: trackByMessageId" 
          [id]="'message-' + msg.id"
          class="mb-4"
          [ngClass]="{
            'd-flex flex-row-reverse': msg.sender === 'user',
            'd-flex': msg.sender === 'assistant'
          }"
          @slideIn>
          
          <!-- Avatar -->
          <div class="flex-shrink-0 mx-3">
            <div class="rounded-circle d-flex align-items-center justify-content-center"
                 [ngClass]="{
                   'bg-primary text-white': msg.sender === 'user',
                   'bg-secondary text-white': msg.sender === 'assistant'
                 }"
                 style="width: 45px; height: 45px; font-size: 20px;">
              <i *ngIf="msg.sender === 'user'" class="bi bi-person-fill"></i>
              <i *ngIf="msg.sender === 'assistant'" class="bi bi-robot"></i>
            </div>
          </div>
          
          <!-- Message Content -->
          <div class="flex-grow-1" style="max-width: 70%;">
            <div 
              class="card shadow-sm"
              [ngClass]="{
                'bg-primary text-white': msg.sender === 'user',
                'bg-white': msg.sender === 'assistant',
                'border-warning': msg.isStreaming
              }">
              <div class="card-body">
                
                <!-- Loading Indicator -->
                <div *ngIf="msg.isLoading && !msg.content" class="d-flex gap-2 align-items-center">
                  <div class="spinner-grow spinner-grow-sm text-secondary" role="status">
                    <span class="visually-hidden">Chargement...</span>
                  </div>
                  <div class="spinner-grow spinner-grow-sm text-secondary" role="status" style="animation-delay: 0.2s;">
                    <span class="visually-hidden">Chargement...</span>
                  </div>
                  <div class="spinner-grow spinner-grow-sm text-secondary" role="status" style="animation-delay: 0.4s;">
                    <span class="visually-hidden">Chargement...</span>
                  </div>
                  <span class="text-muted ms-2">L'assistant réfléchit...</span>
                </div>
                
                <!-- Message Text avec Markdown -->
                <div *ngIf="msg.content" class="message-text-wrapper">
                  <markdown 
                    [data]="msg.content"
                    class="markdown-content"
                    [ngClass]="{'markdown-user': msg.sender === 'user'}">
                  </markdown>
                  <span *ngIf="msg.isStreaming" class="typing-cursor">▊</span>
                </div>
                
                <!-- Actions -->
                <div *ngIf="!msg.isLoading && !msg.isStreaming && msg.content" 
                     class="mt-3 pt-2 border-top"
                     [class.border-light]="msg.sender === 'user'">
                  <div class="d-flex gap-2">
                    <button 
                      class="btn btn-sm"
                      [ngClass]="{
                        'btn-light': msg.sender === 'user',
                        'btn-outline-secondary': msg.sender === 'assistant'
                      }"
                      (click)="copyMessage(msg.content)"
                      title="Copier">
                      <i class="bi bi-clipboard"></i>
                    </button>
                    <button 
                      *ngIf="msg.sender === 'assistant'"
                      class="btn btn-sm btn-outline-secondary"
                      (click)="regenerateLastResponse()"
                      title="Régénérer">
                      <i class="bi bi-arrow-clockwise"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Timestamp -->
            <small 
              class="text-muted mt-1 d-block"
              [ngClass]="{
                'text-end': msg.sender === 'user',
                'text-start': msg.sender === 'assistant'
              }">
              <i class="bi bi-clock me-1"></i>
              {{ formatTime(msg.timestamp) }}
            </small>
          </div>
        </div>
        
        <!-- État vide -->
        <div *ngIf="!(hasMessages$ | async)" class="text-center py-5" @fadeIn>
          <i class="bi bi-chat-dots display-1 text-muted opacity-50"></i>
          <h3 class="mt-4 mb-2">Commencez une conversation</h3>
          <p class="text-muted mb-4">Uploadez des documents et posez vos questions</p>
          
          <div class="d-flex flex-wrap justify-content-center gap-2">
            <button 
              class="btn btn-outline-primary btn-sm" 
              (click)="sendMessage('Résume les documents uploadés')"
              [disabled]="!(canSendMessage$ | async)">
              <i class="bi bi-lightbulb me-1"></i>
              Résumer les documents
            </button>
            <button 
              class="btn btn-outline-primary btn-sm" 
              (click)="sendMessage('Quelles sont les images dans les fichiers ?')"
              [disabled]="!(canSendMessage$ | async)">
              <i class="bi bi-image me-1"></i>
              Trouver les images
            </button>
            <button 
              class="btn btn-outline-primary btn-sm" 
              (click)="sendMessage('Donne-moi les points clés')"
              [disabled]="!(canSendMessage$ | async)">
              <i class="bi bi-list-check me-1"></i>
              Points clés
            </button>
          </div>
        </div>
        
      </div>
      
      <!-- Footer -->
      <footer class="border-top bg-white p-3 shadow-sm">
        
        <div *ngIf="isStreaming$ | async" 
             class="alert alert-info py-2 mb-2 d-flex align-items-center" 
             role="alert">
          <div class="spinner-border spinner-border-sm me-2" role="status">
            <span class="visually-hidden">Streaming...</span>
          </div>
          <small class="mb-0">L'assistant est en train de répondre...</small>
        </div>
        
        <div class="input-group mb-2">
          <textarea
            #messageInput
            class="form-control"
            [(ngModel)]="currentMessage"
            (keydown)="onKeyDown($event)"
            placeholder="Posez votre question..."
            rows="2"
            [disabled]="!(canSendMessage$ | async)"
            style="resize: none;"></textarea>
          
          <button 
            class="btn btn-primary"
            type="button"
            (click)="sendMessage()"
            [disabled]="!currentMessage.trim() || !(canSendMessage$ | async)"
            style="min-width: 100px;">
            
            <span *ngIf="!(isStreaming$ | async) && !(loading$ | async)">
              <i class="bi bi-send-fill me-1"></i>
              Envoyer
            </span>
            
            <span *ngIf="(isStreaming$ | async) || (loading$ | async)">
              <span class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Chargement...</span>
              </span>
            </span>
          </button>
        </div>
        
        <div class="d-flex justify-content-between align-items-center small text-muted">
          <span>
            <kbd>Enter</kbd> pour envoyer • <kbd>Shift + Enter</kbd> pour nouvelle ligne
          </span>
          
          <span>
            <i class="bi bi-chat-dots me-1"></i>
            {{ (messages$ | async)?.length || 0 }} messages
            <span class="mx-2">•</span>
            <i class="bi bi-folder me-1"></i>
            {{ (files$ | async)?.length || 0 }} fichiers
          </span>
        </div>
        
      </footer>
      
    </main>
    
  </div>
</div>